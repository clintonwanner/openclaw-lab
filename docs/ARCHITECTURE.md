# System Architecture

## The "Ironclad" Pivot
Initial designs using standard `docker` and `snap` were discarded due to incompatibility with Firecracker on modern Ubuntu/Pop!_OS kernels. The system has been standardized on a hardened `runc` configuration to ensure stability while maintaining strict security boundaries.

## 1. Runtime Stack
*   **Hypervisor:** **None**. Hardware-level isolation (Kata/Firecracker) was evaluated and officially decoped in favor of standard container isolation for stability and reduced complexity.
*   **Container Runtime:** **Docker (runc)**. The active runtime for all containers (`openclaw_vm`, `warden_sentry`, `airlock_gui`). Standard namespaces and cgroups provide the primary isolation boundary.
*   **Orchestration:** **Docker Compose**. Manages the lifecycle, networking, and volumes of the stack.
*   **CLI:** **docker**. Standard Docker CLI is used for management.

## 2. Storage Strategy
*   **Root Filesystem:** Standard Docker overlay2 storage driver. Persistence is managed via the host bind mount.
*   **Workspace (Data):** The `/app/workspace` directory is **bind-mounted** from the host's `<PROJECT_ROOT>/sandbox_data`. This allows the Warden (running in a separate container) to scan files generated by the Agent in real-time.
*   **Configuration Backup:** A critical configuration backup (`openclaw.json`) is maintained in `sandbox_data/openclaw_backup` and restored on container startup if needed.

## 3. Network Architecture
*   **Bridge:** `openclaw-lab_isolated_vlan` (Docker Bridge).
*   **Agent (Loopback Strategy):** The gateway binds to `127.0.0.1:18789` inside the container. The internal agent is explicitly configured via `OPENCLAW_GATEWAY_URL` to use this loopback address.
*   **Port Mapping:** Container `127.0.0.1:18789` -> Host `0.0.0.0:18789`. This allows external access (LAN/Host) while ensuring internal agent traffic is isolated to the container's loopback interface.
*   **Isolation (The Moat):** **Active**. Traffic from the bridge interface to private LAN ranges (`192.168.0.0/16`, `10.0.0.0/8`, `172.16.0.0/12`) is blocked via `iptables`. By using the loopback strategy, internal agent-to-gateway communication bypasses these rules entirely, ensuring 100% reliability without compromising the security moat.

## 4. Component Interaction

1.  **Agent (Prisoner):** Node.js 22 (Debian Bookworm) running OpenClaw. It treats `/app/.openclaw` (config) and `/app/workspace` (work) as its primary drives. The agent is configured to use **NVIDIA Moonshot Kimi 2.5** as its primary reasoning engine, providing advanced multimodal and long-context capabilities via the NVIDIA API.

2.  **Shared Volume:** Both the configuration and the workspace are bind-mounted to the host at `<PROJECT_ROOT>/sandbox_data/`. This ensures 100% persistence of pairings, sessions, and Telegram settings.

3.  **Warden:** Mounts the workspace. Uses `inotifywait` to detect `CLOSE_WRITE` events for real-time malware scanning.

4.  **Airlock:** Mounts the workspace to provide a secure Web UI for the user to retrieve files without direct container access.
